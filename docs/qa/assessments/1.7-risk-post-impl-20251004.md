# Risk Profile: Story 1.7 - Hosting and Production Environment Setup

**Date:** 2025-10-04
**Reviewer:** Quinn (Test Architect)
**Story Status:** Draft (Pre-Implementation Analysis)

## Executive Summary

- **Total Risks Identified:** 18
- **Critical Risks (Score 9):** 2
- **High Risks (Score 6):** 5
- **Medium Risks (Score 4):** 7
- **Low Risks (Score 2-3):** 4
- **Overall Risk Score:** 46/100 (High Risk - Requires Careful Execution)

**Key Concern:** Infrastructure deployment with production database operations presents elevated risk. Two critical risks (ENV-001, DATA-001) require immediate mitigation before deployment.

---

## Critical Risks Requiring Immediate Attention

### 1. SEC-001: Environment Secrets Exposure

**Score: 9 (Critical)**
**Category:** Security
**Probability:** High (3) - Manual configuration prone to human error
**Impact:** High (3) - Database compromise, unauthorized access, data breach

**Description:**
Production database credentials and API keys configured manually in Vercel dashboard could be accidentally committed to Git, exposed in logs, or misconfigured with incorrect scopes.

**Affected Components:**

- Vercel environment variables configuration
- `.env.local` file (risk of accidental commit)
- Supabase service role key (admin-level access)
- Database connection strings

**Mitigation Strategy: Preventive**

**Actions:**

1. Verify `.env.local` in `.gitignore` before ANY configuration
2. Use Vercel secrets naming convention (`@database_url`) exclusively
3. Implement secret scanning in CI pipeline (Gitleaks or similar)
4. Restrict `SUPABASE_SERVICE_KEY` to production scope only
5. Use separate credentials for dev/staging/production
6. Document secret rotation procedure

**Testing Requirements:**

- Pre-deployment checklist verification
- Git history scan for leaked secrets
- Vercel dashboard audit (correct secret scopes)
- Secret rotation procedure dry-run

**Residual Risk:** Low - With proper procedures, risk minimal
**Owner:** Dev team + Operations
**Timeline:** BEFORE any environment variable configuration

---

### 2. DATA-001: Production Database Migration Failure

**Score: 9 (Critical)**
**Category:** Data
**Probability:** High (3) - First production migration, no rollback tested
**Impact:** High (3) - Data corruption, application unusable, extended downtime

**Description:**
Database migration (`pnpm db:migrate`) executed directly against production Supabase database without rollback plan. Failed migration could leave schema in inconsistent state.

**Affected Components:**

- Prisma migrations in `prisma/migrations/`
- Production Supabase database
- Seed script (`prisma/seed.ts`)
- Application startup (depends on correct schema)

**Mitigation Strategy: Preventive + Corrective**

**Actions:**

1. Create pre-migration backup via Supabase dashboard
2. Test migration against Supabase staging/preview environment first
3. Document rollback procedure:
   - Restore from backup point
   - Revert migration via Prisma
4. Verify migration idempotency (safe to re-run)
5. Run migration during low-traffic window
6. Monitor database logs during migration

**Testing Requirements:**

- Migration dry-run against staging database
- Rollback procedure validation
- Seed script idempotency testing
- Schema verification queries post-migration

**Residual Risk:** Medium - Database operations inherently risky
**Owner:** Dev team (primary) + DBA review (if available)
**Timeline:** BEFORE running production migration (AC#5)

---

## High Risks (Score 6)

### 3. OPS-001: Vercel Deployment Configuration Error

**Score: 6 (High)**
**Category:** Operational
**Probability:** Medium (2) - First deployment, manual configuration
**Impact:** High (3) - Application inaccessible, deployment failures

**Description:**
Incorrect `vercel.json` configuration or Vercel dashboard settings could prevent successful deployment or break production environment.

**Mitigation:**

- Validate `vercel.json` against documentation
- Use Vercel preview deployments first (PR-based)
- Test build command locally before deployment
- Monitor first deployment logs closely

**Testing:** Local build verification, preview deployment test
**Owner:** Dev team
**Timeline:** During Task 1 (Vercel configuration)

---

### 4. TECH-001: Database Connection Pool Exhaustion

**Score: 6 (High)**
**Category:** Technical
**Probability:** Medium (2) - Serverless environment, connection pooling complexity
**Impact:** High (3) - Application crashes, 503 errors

**Description:**
Supabase pooler (port 6543) required for serverless, but Prisma connection management not optimized could exhaust connections under load.

**Mitigation:**

- Use Supabase pooler port 6543 (NOT direct port 5432)
- Configure Prisma connection pool limits
- Implement connection timeout handling
- Monitor connection usage in Supabase dashboard

**Testing:** Load testing with concurrent requests, connection monitoring
**Owner:** Dev team
**Timeline:** During AC#2 configuration

---

### 5. PERF-001: Health Check Database Query Latency

**Score: 6 (High)**
**Category:** Performance
**Probability:** High (3) - Network latency to Supabase, cold starts
**Impact:** Medium (2) - False negatives in health checks, monitoring alerts

**Description:**
Health check endpoint (`/api/health`) performs database query (`SELECT 1`) which could timeout on cold starts or high latency connections.

**Mitigation:**

- Implement health check timeout (e.g., 2 seconds)
- Return degraded status (503) on timeout, not crash
- Consider cached health status with TTL
- Monitor health check response times

**Testing:** Cold start simulation, latency injection testing
**Owner:** Dev team
**Timeline:** During AC#6 implementation

---

### 6. OPS-002: Insufficient 24-Hour Monitoring

**Score: 6 (High)**
**Category:** Operational
**Probability:** Medium (2) - Manual monitoring, easy to miss issues
**Impact:** High (3) - Silent failures, delayed incident response

**Description:**
AC#10 requires 24-hour stability verification but no automated monitoring configured. Manual checks could miss intermittent failures.

**Mitigation:**

- Set up Vercel deployment notifications
- Configure Supabase alerting for database issues
- Create monitoring checklist with specific metrics
- Schedule health check pings every 5 minutes
- Document escalation procedure

**Testing:** Monitoring checklist dry-run, alert configuration verification
**Owner:** Operations / Dev team
**Timeline:** During AC#10 (Task 7)

---

### 7. SEC-002: Public Storage Bucket Misconfiguration

**Score: 6 (High)**
**Category:** Security
**Probability:** Medium (2) - RLS policies, manual configuration
**Impact:** High (3) - Unauthorized file access, data exposure

**Description:**
Supabase storage bucket `lesson-resources` configured for public read access. Incorrect RLS policies could allow unauthorized uploads or deletion.

**Mitigation:**

- Implement least-privilege RLS policies
- Public read only, authenticated write
- Test bucket access with unauthenticated requests
- Document bucket security configuration

**Testing:** Security testing with various auth states, RLS policy validation
**Owner:** Dev team
**Timeline:** During AC#2 (storage bucket setup)

---

## Medium Risks (Score 4)

### 8. TECH-002: CORS Configuration Gaps

**Score: 4 (Medium)**
**Category:** Technical
**Probability:** Low (1) - Next.js same-origin deployment
**Impact:** High (3) - API inaccessible, frontend broken

**Mitigation:** Verify same-origin deployment, test API calls from frontend
**Owner:** Dev team
**Timeline:** AC#8

---

### 9. DATA-002: Backup Schedule Not Enabled

**Score: 4 (Medium)**
**Category:** Data
**Probability:** Medium (2) - Manual verification required
**Impact:** Medium (2) - Data loss risk if failure occurs

**Mitigation:** Explicitly verify backup schedule in Supabase dashboard, document verification
**Owner:** Operations
**Timeline:** AC#2, AC#9

---

### 10. PERF-002: Edge Network Routing Delays

**Score: 4 (Medium)**
**Category:** Performance
**Probability:** Medium (2) - Geographic distribution, DNS propagation
**Impact:** Medium (2) - Slower page loads, poor UX

**Mitigation:** Use Vercel edge network, monitor Web Vitals, test from multiple locations
**Owner:** Dev team
**Timeline:** AC#7 verification

---

### 11. OPS-003: Incomplete Documentation

**Score: 4 (Medium)**
**Category:** Operational
**Probability:** Medium (2) - Post-deployment documentation often rushed
**Impact:** Medium (2) - Difficult incident response, knowledge loss

**Mitigation:** Document production URL, credentials, access procedures during deployment
**Owner:** Dev team
**Timeline:** AC#10 (Task 7)

---

### 12. TECH-003: Build Command Failure

**Score: 4 (Medium)**
**Category:** Technical
**Probability:** Low (1) - CI pipeline already validates builds
**Impact:** High (3) - Deployment blocked, rollback needed

**Mitigation:** CI pipeline from Story 1.6 validates builds, Vercel build logs monitoring
**Owner:** Dev team
**Timeline:** Continuous (CI)

---

### 13. DATA-003: Seed Data Duplication

**Score: 4 (Medium)**
**Category:** Data
**Probability:** Medium (2) - Seed script re-run not idempotent
**Impact:** Medium (2) - Duplicate records, data inconsistency

**Mitigation:** Make seed script idempotent (check existence before insert), test multiple runs
**Owner:** Dev team
**Timeline:** AC#5

---

### 14. SEC-003: Missing HTTPS Enforcement

**Score: 4 (Medium)**
**Category:** Security
**Probability:** Low (1) - Vercel auto-provisions HTTPS
**Impact:** High (3) - Data interception, MITM attacks

**Mitigation:** Verify certificate provisioned, test HTTPS redirect, check mixed content warnings
**Owner:** Dev team
**Timeline:** AC#4

---

## Low Risks (Score 2-3)

### 15. BUS-001: Delayed Deployment Timeline

**Score: 3 (Low)**
**Category:** Business
**Probability:** Low (1) - Well-scoped story
**Impact:** High (3) - Blocked dependent stories

**Mitigation:** Follow task sequence, no shortcuts on verification
**Owner:** PM
**Timeline:** Continuous

---

### 16. PERF-003: Web Vitals Below Target

**Score: 3 (Low)**
**Category:** Performance
**Probability:** Low (1) - Optimized Next.js app
**Impact:** High (3) - Poor UX, SEO impact

**Mitigation:** Monitor Vercel Analytics, run Lighthouse audits
**Owner:** Dev team
**Timeline:** AC#7

---

### 17. OPS-004: Vercel Analytics Not Enabled

**Score: 2 (Low)**
**Category:** Operational
**Probability:** Low (1) - Already configured in `app/layout.tsx`
**Impact:** Medium (2) - No performance visibility

**Mitigation:** Verify Analytics and SpeedInsights components present
**Owner:** Dev team
**Timeline:** AC#7

---

### 18. TECH-004: Environment Variable Typo

**Score: 2 (Low)**
**Category:** Technical
**Probability:** Low (1) - Documented configuration, copy-paste from Supabase
**Impact:** Medium (2) - Application crashes, deployment failure

**Mitigation:** Double-check variable names against documentation, test locally with production env vars
**Owner:** Dev team
**Timeline:** AC#3

---

## Risk Distribution

### By Category

| Category    | Total Risks | Critical | High | Medium | Low |
| ----------- | ----------- | -------- | ---- | ------ | --- |
| Security    | 3           | 1        | 1    | 1      | 0   |
| Data        | 4           | 1        | 0    | 2      | 1   |
| Operational | 5           | 0        | 2    | 2      | 1   |
| Technical   | 4           | 0        | 1    | 2      | 1   |
| Performance | 3           | 0        | 1    | 1      | 1   |
| Business    | 1           | 0        | 0    | 0      | 1   |

### By Component

| Component                 | Risk Count | Highest Score |
| ------------------------- | ---------- | ------------- |
| Database/Supabase         | 7          | 9 (DATA-001)  |
| Vercel Deployment         | 4          | 6 (OPS-001)   |
| Environment Configuration | 3          | 9 (SEC-001)   |
| Health Check Endpoint     | 1          | 6 (PERF-001)  |
| Monitoring/Observability  | 2          | 6 (OPS-002)   |
| Frontend Integration      | 1          | 4 (TECH-002)  |

---

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests (Must Execute Before Deployment)

#### SEC-001 Mitigation Tests

- **Test 1.7-SEC-001-A:** Verify `.env.local` in `.gitignore`
- **Test 1.7-SEC-001-B:** Scan Git history for exposed secrets (Gitleaks)
- **Test 1.7-SEC-001-C:** Audit Vercel secrets configuration (correct scopes)
- **Test 1.7-SEC-001-D:** Verify production secrets differ from dev

#### DATA-001 Mitigation Tests

- **Test 1.7-DATA-001-A:** Staging migration dry-run (Supabase preview env)
- **Test 1.7-DATA-001-B:** Backup restoration procedure validation
- **Test 1.7-DATA-001-C:** Migration idempotency test (run twice, verify)
- **Test 1.7-DATA-001-D:** Schema verification queries post-migration

### Priority 2: High Risk Tests (Should Execute Before Deployment)

#### OPS-001 (Vercel Configuration)

- **Test 1.7-OPS-001-A:** Local build with production settings
- **Test 1.7-OPS-001-B:** Preview deployment via PR
- **Test 1.7-OPS-001-C:** `vercel.json` validation against docs

#### TECH-001 (Connection Pooling)

- **Test 1.7-TECH-001-A:** Prisma connection pool configuration review
- **Test 1.7-TECH-001-B:** Load test with 50 concurrent requests
- **Test 1.7-TECH-001-C:** Monitor Supabase connection metrics

#### PERF-001 (Health Check Latency)

- **Test 1.7-PERF-001-A:** Cold start simulation (health check timeout)
- **Test 1.7-PERF-001-B:** Latency injection test (degraded response)

#### OPS-002 (24-Hour Monitoring)

- **Test 1.7-OPS-002-A:** Configure automated health check pings
- **Test 1.7-OPS-002-B:** Verify Vercel deployment notifications
- **Test 1.7-OPS-002-C:** Test alert escalation procedure

#### SEC-002 (Storage Bucket)

- **Test 1.7-SEC-002-A:** Unauthenticated read access test (should succeed)
- **Test 1.7-SEC-002-B:** Unauthenticated write test (should fail)
- **Test 1.7-SEC-002-C:** RLS policy validation

### Priority 3: Medium Risk Tests (Execute Post-Deployment)

- CORS verification (TECH-002)
- Backup schedule verification (DATA-002)
- Geographic latency testing (PERF-002)
- Documentation completeness review (OPS-003)
- Seed script idempotency (DATA-003)
- HTTPS certificate validation (SEC-003)

### Priority 4: Low Risk Tests (Opportunistic)

- Web Vitals monitoring (PERF-003)
- Analytics component verification (OPS-004)
- Environment variable spelling check (TECH-004)

---

## Risk Acceptance Criteria

### Must Fix Before Production Deployment

1. **SEC-001:** Environment secrets exposure - MUST mitigate fully
2. **DATA-001:** Database migration failure - MUST have rollback plan
3. **OPS-001:** Vercel configuration - MUST test in preview first
4. **TECH-001:** Connection pooling - MUST configure correctly
5. **PERF-001:** Health check latency - MUST implement timeout

### Can Deploy with Mitigation

- **OPS-002:** 24-hour monitoring - Deploy with manual monitoring plan
- **SEC-002:** Storage bucket - Deploy with RLS policies, verify immediately
- **Medium risks:** Accept with documented compensating controls

### Accepted Risks (With Justification)

- **BUS-001:** Timeline delays - Acceptable with communication to stakeholders
- **PERF-003:** Web Vitals - Monitor post-deployment, iterate if needed
- **OPS-004:** Analytics - Already configured, low verification effort

---

## Monitoring Requirements Post-Deployment

### Critical Monitoring (First 24 Hours)

1. **Health Check Endpoint:**
   - Ping every 5 minutes
   - Alert on 2 consecutive failures
   - Track response time trends

2. **Database Metrics (Supabase Dashboard):**
   - Connection count
   - Query performance
   - Error rates
   - Backup execution status

3. **Vercel Deployment Logs:**
   - Function errors (HTTP 500)
   - Build failures
   - Edge network errors
   - Request volumes

4. **Web Vitals (Vercel Analytics):**
   - LCP (target <3s)
   - FID (target <100ms)
   - CLS (target <0.1)

### Ongoing Monitoring (Post-24 Hours)

- Weekly backup verification
- Monthly secret rotation review
- Quarterly disaster recovery drill
- Continuous Web Vitals tracking

---

## Risk Review Triggers

Review and update this risk profile when:

1. **Immediate Triggers:**
   - Any critical risk materializes (SEC-001, DATA-001)
   - Production incident occurs
   - New deployment configuration changes

2. **Periodic Triggers:**
   - Before major releases
   - Quarterly security reviews
   - After architecture changes

3. **Environmental Triggers:**
   - Vercel platform updates
   - Supabase service changes
   - New security vulnerabilities disclosed

---

## Quality Gate Impact

**Deterministic Gate Mapping:**

- **2 Critical Risks (Score 9)** â†’ Gate Decision: **CONCERNS**
  - Would be FAIL if unmitigated
  - Can proceed with documented mitigation plans
  - Requires explicit acceptance of residual risk

**Justification:**
Infrastructure stories inherently carry higher risk. With proper mitigation strategies documented and tested, deployment can proceed under controlled conditions with enhanced monitoring.

**Recommendation:** Proceed to implementation with mandatory execution of Priority 1 and Priority 2 tests before production deployment.

---

## Summary Statistics

- **Total Risk Points:** 106 (sum of all risk scores)
- **Average Risk Score:** 5.9 (High-Medium range)
- **Risk Concentration:** Database and deployment (11/18 risks)
- **Mitigation Coverage:** 100% (all risks have defined mitigations)
- **Testing Coverage:** 23 specific test scenarios identified
- **Residual Risk Assessment:** Medium (with mitigations applied)

**Overall Assessment:** High-risk story requiring careful execution and comprehensive testing. Critical risks (SEC-001, DATA-001) must be fully mitigated before production deployment. Strong monitoring essential for first 24 hours.
