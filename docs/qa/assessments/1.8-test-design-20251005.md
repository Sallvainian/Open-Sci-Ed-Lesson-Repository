# Test Design: Story 1.8

**Date:** 2025-10-05
**Designer:** Quinn (Test Architect)
**Story:** Middleware Integration Tests + Vite CJS Fix

## Test Strategy Overview

- **Total test scenarios:** 20
- **Unit tests:** 0 (0%) - No pure logic suitable for unit testing
- **Integration tests:** 20 (100%) - All tests verify middleware component interactions
- **E2E tests:** 0 (0%) - Integration tests sufficient for middleware validation
- **Priority distribution:** P0: 17 tests (85%), P1: 3 tests (15%)

**Test Level Justification:**
All 20 tests are **integration tests** because:

1. Middleware interacts with multiple components (NextRequest, NextResponse, JWT verification, console logging)
2. Tests validate component boundaries (request → middleware → response)
3. No pure business logic suitable for unit testing (all logic involves framework interactions)
4. E2E tests not needed (middleware operates at request/response level, no user interface)

**Performance Target:** <10 seconds total execution time (AC 14)

**Coverage Target:** 95%+ for `middleware.ts` (AC 13)

---

## Test Scenarios by Acceptance Criteria

### AC1: Middleware Test File Created

**Requirement:** Create `middleware.test.ts` with 20 integration test scenarios

**Implementation Note:** This AC is meta-criteria satisfied by completing all tests below. No explicit test scenario required.

**File Location:** `middleware.test.ts` (project root, same level as `middleware.ts`)

---

### AC2: Public Paths Bypass Authentication

**Requirement:** All public paths tested (login, auth endpoints, health check) bypass authentication correctly

#### Test Scenarios

| ID          | Level       | Priority | Test                                             | Justification                                     | Mitigates Risks |
| ----------- | ----------- | -------- | ------------------------------------------------ | ------------------------------------------------- | --------------- |
| 1.8-INT-001 | Integration | P0       | GET /login allows access without authentication  | Critical: Prevents users from reaching login page | SEC-001         |
| 1.8-INT-002 | Integration | P0       | POST /api/auth/login allows access without auth  | Critical: Must allow unauthenticated login        | SEC-001         |
| 1.8-INT-003 | Integration | P0       | POST /api/auth/logout allows access without auth | Critical: Logout must work for all users          | SEC-001         |
| 1.8-INT-004 | Integration | P0       | GET /api/health allows access without auth       | Critical: Health checks for monitoring            | SEC-001         |

**Test Implementation Details:**

**1.8-INT-001: GET /login allows access without authentication**

```typescript
it('should allow access to /login without authentication (1.8-INT-001)', async () => {
  const request = createMockRequest('/login');
  const response = await middleware(request);

  expect(response.status).toBe(200); // NextResponse.next() indicates success
  expect(verifyToken).not.toHaveBeenCalled(); // No token validation
});
```

**Priority Justification:** P0 - Security-critical path. If `/login` requires authentication, users cannot log in (circular dependency). This is a **blocking issue** that would break the entire authentication flow.

**1.8-INT-002: POST /api/auth/login allows access without authentication**

```typescript
it('should allow access to POST /api/auth/login (1.8-INT-002)', async () => {
  const request = createMockRequest('/api/auth/login', { method: 'POST' });
  const response = await middleware(request);

  expect(response.status).toBe(200);
  expect(verifyToken).not.toHaveBeenCalled();
});
```

**Priority Justification:** P0 - Revenue-critical. If login endpoint requires authentication, no user can log in. System is completely unusable.

**1.8-INT-003: POST /api/auth/logout allows access without authentication**

```typescript
it('should allow access to POST /api/auth/logout (1.8-INT-003)', async () => {
  const request = createMockRequest('/api/auth/logout', { method: 'POST' });
  const response = await middleware(request);

  expect(response.status).toBe(200);
  expect(verifyToken).not.toHaveBeenCalled();
});
```

**Priority Justification:** P0 - Security issue. If logout requires authentication, users with expired tokens cannot log out properly, leaving stale sessions.

**1.8-INT-004: GET /api/health allows access without authentication**

```typescript
it('should allow access to GET /api/health (1.8-INT-004)', async () => {
  const request = createMockRequest('/api/health');
  const response = await middleware(request);

  expect(response.status).toBe(200);
  expect(verifyToken).not.toHaveBeenCalled();
});
```

**Priority Justification:** P0 - Operational requirement. Health checks must be unauthenticated for monitoring systems (Vercel health checks, external monitoring services).

---

### AC3: Protected Pages Redirect When Unauthenticated

**Requirement:** Protected page routes redirect to `/login` with 303 status when unauthenticated

#### Test Scenarios

| ID          | Level       | Priority | Test                                           | Justification                | Mitigates Risks |
| ----------- | ----------- | -------- | ---------------------------------------------- | ---------------------------- | --------------- |
| 1.8-INT-006 | Integration | P0       | GET /dashboard (no cookie) redirects to /login | Core user journey protection | SEC-001         |
| 1.8-INT-007 | Integration | P0       | GET / (no cookie) redirects to /login          | Homepage must be protected   | SEC-001         |

**Test Implementation Details:**

**1.8-INT-006: GET /dashboard (no cookie) redirects to /login with 303**

```typescript
it('should redirect GET /dashboard to /login when no cookie present (1.8-INT-006)', async () => {
  const request = createMockRequest('/dashboard');
  const response = await middleware(request);

  expect(response.status).toBe(303); // See Other (redirect)
  expect(response.headers.get('location')).toBe('http://localhost:3000/login');
});
```

**Priority Justification:** P0 - Core user journey. Dashboard is primary landing page for authenticated users. Failure would allow unauthorized access to sensitive lesson data.

**1.8-INT-007: GET / (no cookie) redirects to /login with 303**

```typescript
it('should redirect GET / to /login when no cookie present (1.8-INT-007)', async () => {
  const request = createMockRequest('/');
  const response = await middleware(request);

  expect(response.status).toBe(303);
  expect(response.headers.get('location')).toBe('http://localhost:3000/login');
});
```

**Priority Justification:** P0 - Security-critical. Homepage is protected route. Unauthenticated access would expose entire application.

---

### AC4: Protected APIs Return 401 When Unauthenticated

**Requirement:** Protected API routes return 401 JSON response when unauthenticated

#### Test Scenarios

| ID          | Level       | Priority | Test                                        | Justification            | Mitigates Risks |
| ----------- | ----------- | -------- | ------------------------------------------- | ------------------------ | --------------- |
| 1.8-INT-008 | Integration | P0       | GET /api/users (no cookie) returns 401 JSON | API security enforcement | SEC-001         |

**Test Implementation Details:**

**1.8-INT-008: GET /api/users (no cookie) returns 401 JSON**

```typescript
it('should return 401 JSON for GET /api/users when no cookie present (1.8-INT-008)', async () => {
  const request = createMockRequest('/api/users');
  const response = await middleware(request);

  expect(response.status).toBe(401);
  const data = await response.json();
  expect(data.error).toBe('UNAUTHORIZED');
  expect(data.message).toBe('Authentication required');
});
```

**Priority Justification:** P0 - Data security. API endpoints expose user data. Unauthorized access would violate privacy and security requirements.

---

### AC5: Valid JWT Tokens Allow Access

**Requirement:** Valid JWT tokens allow access to protected routes (NextResponse.next() called)

#### Test Scenarios

| ID          | Level       | Priority | Test                                  | Justification                     | Mitigates Risks |
| ----------- | ----------- | -------- | ------------------------------------- | --------------------------------- | --------------- |
| 1.8-INT-012 | Integration | P0       | GET /dashboard (valid token) proceeds | Core authentication success path  | SEC-001         |
| 1.8-INT-013 | Integration | P0       | GET /api/users (valid token) proceeds | API access with valid credentials | SEC-001         |

**Test Implementation Details:**

**1.8-INT-012: GET /dashboard (valid token) proceeds with NextResponse.next()**

```typescript
it('should allow access to GET /dashboard with valid token (1.8-INT-012)', async () => {
  // Mock verifyToken to return valid payload
  vi.mocked(verifyToken).mockReturnValue({ username: 'teacher', id: '1' });

  const request = createMockRequest('/dashboard', { token: 'valid-jwt-token' });
  const response = await middleware(request);

  expect(response.status).toBe(200); // NextResponse.next() = 200
  expect(verifyToken).toHaveBeenCalledWith('valid-jwt-token');
});
```

**Priority Justification:** P0 - Core user journey. Authenticated users must access dashboard. Failure blocks all legitimate users.

**1.8-INT-013: GET /api/users (valid token) proceeds with NextResponse.next()**

```typescript
it('should allow access to GET /api/users with valid token (1.8-INT-013)', async () => {
  vi.mocked(verifyToken).mockReturnValue({ username: 'teacher', id: '1' });

  const request = createMockRequest('/api/users', { token: 'valid-jwt-token' });
  const response = await middleware(request);

  expect(response.status).toBe(200);
  expect(verifyToken).toHaveBeenCalledWith('valid-jwt-token');
});
```

**Priority Justification:** P0 - Core functionality. API access required for all authenticated operations. Failure breaks data fetching.

---

### AC6: Invalid/Expired Tokens Trigger Authentication Failure

**Requirement:** Invalid/expired tokens trigger authentication failure handling

#### Test Scenarios

| ID          | Level       | Priority | Test                                               | Justification                      | Mitigates Risks |
| ----------- | ----------- | -------- | -------------------------------------------------- | ---------------------------------- | --------------- |
| 1.8-INT-009 | Integration | P0       | GET /dashboard (invalid token) redirects to /login | Security: Block tampered tokens    | SEC-001         |
| 1.8-INT-010 | Integration | P0       | GET / (invalid token) redirects to /login          | Security: Protect homepage         | SEC-001         |
| 1.8-INT-011 | Integration | P0       | GET /api/users (invalid token) returns 401 JSON    | Security: Reject invalid API calls | SEC-001         |

**Test Implementation Details:**

**1.8-INT-009: GET /dashboard (invalid token) redirects to /login with 303**

```typescript
it('should redirect GET /dashboard to /login with invalid token (1.8-INT-009)', async () => {
  // Mock verifyToken to return null (invalid token)
  vi.mocked(verifyToken).mockReturnValue(null);

  const request = createMockRequest('/dashboard', { token: 'invalid-token' });
  const response = await middleware(request);

  expect(response.status).toBe(303);
  expect(response.headers.get('location')).toBe('http://localhost:3000/login');
  expect(verifyToken).toHaveBeenCalledWith('invalid-token');
});
```

**Priority Justification:** P0 - Security-critical. Invalid tokens (tampered, expired, or malicious) must be rejected. Failure allows unauthorized access.

**1.8-INT-010: GET / (invalid token) redirects to /login with 303**

```typescript
it('should redirect GET / to /login with invalid token (1.8-INT-010)', async () => {
  vi.mocked(verifyToken).mockReturnValue(null);

  const request = createMockRequest('/', { token: 'invalid-token' });
  const response = await middleware(request);

  expect(response.status).toBe(303);
  expect(response.headers.get('location')).toBe('http://localhost:3000/login');
  expect(verifyToken).toHaveBeenCalledWith('invalid-token');
});
```

**Priority Justification:** P0 - Security-critical. Homepage protection against token tampering.

**1.8-INT-011: GET /api/users (invalid token) returns 401 JSON**

```typescript
it('should return 401 JSON for GET /api/users with invalid token (1.8-INT-011)', async () => {
  vi.mocked(verifyToken).mockReturnValue(null);

  const request = createMockRequest('/api/users', { token: 'invalid-token' });
  const response = await middleware(request);

  expect(response.status).toBe(401);
  const data = await response.json();
  expect(data.error).toBe('UNAUTHORIZED');
  expect(data.message).toBe('Authentication required');
  expect(verifyToken).toHaveBeenCalledWith('invalid-token');
});
```

**Priority Justification:** P0 - Data security. API must reject tampered/expired tokens to prevent unauthorized data access.

---

### AC7: OPTIONS Requests Return 200 with CORS Headers

**Requirement:** OPTIONS requests return 200 with CORS headers without authentication requirement

#### Test Scenarios

| ID          | Level       | Priority | Test                                             | Justification                          | Mitigates Risks |
| ----------- | ----------- | -------- | ------------------------------------------------ | -------------------------------------- | --------------- |
| 1.8-INT-005 | Integration | P0       | OPTIONS /api/users returns 200 with CORS headers | CORS preflight must be unauthenticated | SEC-001         |

**Test Implementation Details:**

**1.8-INT-005: OPTIONS /api/users returns 200 with CORS headers**

```typescript
it('should return 200 with CORS headers for OPTIONS /api/users (1.8-INT-005)', async () => {
  const request = createMockRequest('/api/users', { method: 'OPTIONS' });
  const response = await middleware(request);

  expect(response.status).toBe(200);
  expect(response.headers.get('Access-Control-Allow-Origin')).toBeTruthy();
  expect(response.headers.get('Access-Control-Allow-Methods')).toContain('GET');
  expect(response.headers.get('Access-Control-Allow-Methods')).toContain('POST');
  expect(response.headers.get('Access-Control-Allow-Methods')).toContain('PUT');
  expect(response.headers.get('Access-Control-Allow-Methods')).toContain('DELETE');
  expect(response.headers.get('Access-Control-Allow-Headers')).toContain('Authorization');
  expect(verifyToken).not.toHaveBeenCalled();
});
```

**Priority Justification:** P0 - CORS specification requirement. If OPTIONS requests require authentication, browser CORS preflight fails and no API calls work from frontend. This is a **blocking issue** for all cross-origin requests.

---

### AC8: CORS Origin Validation Tested

**Requirement:** CORS origin validation tested (localhost:3000, localhost:3001, \*.vercel.app domains)

#### Test Scenarios

| ID          | Level       | Priority | Test                                              | Justification                   | Mitigates Risks |
| ----------- | ----------- | -------- | ------------------------------------------------- | ------------------------------- | --------------- |
| 1.8-INT-014 | Integration | P1       | Origin http://localhost:3000 sets matching header | Development environment support | SEC-001         |
| 1.8-INT-015 | Integration | P1       | Origin https://\*.vercel.app allowed              | Production deployment support   | SEC-001         |
| 1.8-INT-016 | Integration | P1       | No origin header defaults to same-origin          | Fallback behavior validation    | SEC-001         |

**Test Implementation Details:**

**1.8-INT-014: Origin http://localhost:3000 sets matching Allow-Origin**

```typescript
it('should set matching Access-Control-Allow-Origin for localhost:3000 (1.8-INT-014)', async () => {
  const request = createMockRequest('/api/users', {
    origin: 'http://localhost:3000',
  });
  const response = await middleware(request);

  expect(response.headers.get('Access-Control-Allow-Origin')).toBe('http://localhost:3000');
});
```

**Priority Justification:** P1 - Development environment functionality. Required for local development, but not blocking for production deployment.

**1.8-INT-015: Origin https://\*.vercel.app allowed (pattern match)**

```typescript
it('should allow https://*.vercel.app origin (1.8-INT-015)', async () => {
  const request = createMockRequest('/api/users', {
    origin: 'https://my-project.vercel.app',
  });
  const response = await middleware(request);

  expect(response.headers.get('Access-Control-Allow-Origin')).toBe('https://my-project.vercel.app');
});
```

**Priority Justification:** P1 - Production deployment support. Vercel preview deployments use \*.vercel.app domains. Important but not critical (production uses same-origin).

**1.8-INT-016: No origin header defaults to same-origin**

```typescript
it('should default to same-origin when no origin header present (1.8-INT-016)', async () => {
  const request = createMockRequest('/api/users'); // No origin header
  const response = await middleware(request);

  const allowOrigin = response.headers.get('Access-Control-Allow-Origin');
  expect(allowOrigin).toBe('http://localhost:3000'); // Request URL origin
});
```

**Priority Justification:** P1 - Fallback behavior. Ensures CORS works when origin is undefined. Edge case but important for robustness.

---

### AC9: Request Logging Verified

**Requirement:** Request logging verified for all middleware executions

#### Test Scenarios

| ID          | Level       | Priority | Test                                                      | Justification                      | Mitigates Risks |
| ----------- | ----------- | -------- | --------------------------------------------------------- | ---------------------------------- | --------------- |
| 1.8-INT-018 | Integration | P1       | Request logged with timestamp/method/path/status/duration | Operational monitoring requirement | OPS-001         |

**Test Implementation Details:**

**1.8-INT-018: Request logged with timestamp, method, path, status, duration**

```typescript
it('should log request with timestamp, method, path, status, duration (1.8-INT-018)', async () => {
  const request = createMockRequest('/login');
  await middleware(request);

  expect(mockConsoleLog).toHaveBeenCalled();
  const logCall = mockConsoleLog.mock.calls[0][0];

  // Verify log format: [timestamp] METHOD path - status (duration)
  expect(logCall).toMatch(/\[\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/); // Timestamp
  expect(logCall).toContain('GET'); // Method
  expect(logCall).toContain('/login'); // Path
  expect(logCall).toMatch(/- \d{3}/); // Status code
  expect(logCall).toMatch(/\(\d+ms\)/); // Duration
});
```

**Priority Justification:** P1 - Operational monitoring. Logs enable troubleshooting and performance analysis. Important for production support but not blocking.

---

### AC10: x-middleware-cache Header Set

**Requirement:** `x-middleware-cache: no-cache` header set on all responses

#### Test Scenarios

| ID          | Level       | Priority | Test                                              | Justification                        | Mitigates Risks |
| ----------- | ----------- | -------- | ------------------------------------------------- | ------------------------------------ | --------------- |
| 1.8-INT-017 | Integration | P0       | x-middleware-cache: no-cache set on all responses | Prevents middleware response caching | PERF-001        |

**Test Implementation Details:**

**1.8-INT-017: x-middleware-cache: no-cache set on all responses**

```typescript
it('should set x-middleware-cache: no-cache on all responses (1.8-INT-017)', async () => {
  const request = createMockRequest('/api/users');
  const response = await middleware(request);

  expect(response.headers.get('x-middleware-cache')).toBe('no-cache');
});
```

**Priority Justification:** P0 - Security and correctness. Caching middleware responses would cause stale authentication decisions (user logs out but cached response still allows access). **Critical security issue**.

---

### AC11-12: Vite CJS Fix

**Requirement:** Package.json updated with `"type": "module"` to fix Vite CJS deprecation warning, no warnings during test execution

**Implementation Note:** These ACs are verified through manual testing (Task 1) and covered by overall test suite execution. No explicit test scenario required (build/environment configuration).

**Verification Steps:**

1. Run `pnpm test` - expect no Vite CJS warnings
2. Run `pnpm dev` - expect no Vite CJS warnings

---

### AC13-14: Coverage and Performance

**Requirement:** Middleware coverage reaches 95%+, test execution completes in <10 seconds

**Implementation Note:** These ACs are meta-criteria verified through test execution metrics (Task 13). No explicit test scenario required.

**Verification Steps:**

1. Run `pnpm test:coverage` - verify middleware.ts shows 95%+ coverage
2. Run `pnpm test middleware.test.ts` - verify execution <10 seconds

---

### Edge Cases and Security

**Requirement:** Edge case path matching logic tested

#### Test Scenarios

| ID          | Level       | Priority | Test                                       | Justification                 | Mitigates Risks   |
| ----------- | ----------- | -------- | ------------------------------------------ | ----------------------------- | ----------------- |
| 1.8-INT-019 | Integration | P0       | /api/auth/logout/extra matches public path | Substring matching validation | TECH-004, SEC-001 |
| 1.8-INT-020 | Integration | P0       | /login/forgot-password matches public path | Substring matching validation | TECH-004, SEC-001 |

**Test Implementation Details:**

**1.8-INT-019: Path /api/auth/logout/extra matches public path (startsWith)**

```typescript
it('should allow access to /api/auth/logout/extra (startsWith match) (1.8-INT-019)', async () => {
  const request = createMockRequest('/api/auth/logout/extra');
  const response = await middleware(request);

  expect(response.status).toBe(200); // Public path matched
  expect(verifyToken).not.toHaveBeenCalled();
});
```

**Priority Justification:** P0 - Security edge case. If `startsWith` matching fails, deep paths under public routes would require authentication incorrectly.

**1.8-INT-020: Path /login/forgot-password matches public path (startsWith)**

```typescript
it('should allow access to /login/forgot-password (startsWith match) (1.8-INT-020)', async () => {
  const request = createMockRequest('/login/forgot-password');
  const response = await middleware(request);

  expect(response.status).toBe(200); // Public path matched
  expect(verifyToken).not.toHaveBeenCalled();
});
```

**Priority Justification:** P0 - User experience. If forgot-password flow requires authentication, users cannot reset passwords. **Blocking issue** for password recovery.

---

## Risk Coverage Mapping

### Critical Risk Mitigation (SEC-001: Authentication Bypass)

**Tests directly mitigating SEC-001:**

- 1.8-INT-001 to 1.8-INT-004: Public path bypass validation
- 1.8-INT-006 to 1.8-INT-007: Protected page redirect enforcement
- 1.8-INT-008: Protected API 401 response
- 1.8-INT-009 to 1.8-INT-011: Invalid token rejection
- 1.8-INT-012 to 1.8-INT-013: Valid token authorization
- 1.8-INT-014 to 1.8-INT-016: CORS origin validation
- 1.8-INT-019 to 1.8-INT-020: Edge case path matching

**Coverage:** 17/20 tests (85%) directly address authentication security

---

### Critical Risk Mitigation (PERF-001: Test Performance)

**Tests directly mitigating PERF-001:**

- All 20 tests use performance-optimized patterns:
  - Reusable `createMockRequest()` helper minimizes object construction overhead
  - `vi.clearAllMocks()` in beforeEach (faster than restore)
  - No unnecessary async/await for synchronous assertions
  - Grouped tests with nested describe blocks share mock setup

**Performance Optimization Strategy:**

1. **Mock creation:** Single helper function, minimal object construction
2. **Mock management:** Clear (not restore) for speed
3. **Async optimization:** Synchronous assertions where possible
4. **Test grouping:** Share setup in describe blocks

**Target:** <10 seconds for all 20 tests (0.5 seconds average per test)

---

### High Risk Mitigation (DATA-001: Coverage Target)

**Coverage Strategy:**

- 20 integration tests covering all middleware branches
- All authentication paths tested (public, protected, OPTIONS)
- All response types tested (redirect, JSON error, success)
- All header validations tested (CORS, cache control)
- Edge cases tested (path matching, missing origin)

**Expected Coverage:** 95%+ for `middleware.ts`

**Acceptable Exclusions:**

- Console.log statements (mocked, intentionally not testing log format details)
- Unreachable error paths (if any exist after refactoring)

---

## Test Execution Strategy

### Recommended Execution Order

**Phase 1: P0 Critical Security Tests (17 tests)**

1. **Public path validation** (1.8-INT-001 to 1.8-INT-004) - Fail fast on authentication bypass
2. **Protected route enforcement** (1.8-INT-006 to 1.8-INT-011) - Validate security layer
3. **Valid token authorization** (1.8-INT-012 to 1.8-INT-013) - Confirm legitimate access
4. **Edge case security** (1.8-INT-019 to 1.8-INT-020) - Path matching vulnerabilities
5. **CORS preflight** (1.8-INT-005) - Prevent CORS failures
6. **Cache control** (1.8-INT-017) - Prevent stale authentication

**Phase 2: P1 Operational Tests (3 tests)** 7. **CORS origin validation** (1.8-INT-014 to 1.8-INT-016) - Cross-origin support 8. **Request logging** (1.8-INT-018) - Operational monitoring

**Rationale:** Run critical security tests first to fail fast on authentication issues. Operational tests (logging, CORS) run last as they're important but not blocking.

---

### Test Independence and Isolation

**Test Isolation Strategy:**

1. **Mock reset:** `vi.clearAllMocks()` in beforeEach ensures no mock state pollution
2. **Independent requests:** Each test creates new NextRequest instance
3. **No shared state:** Tests don't rely on execution order
4. **Parallel execution:** Vitest default parallel mode safe

**Test Grouping:**

- Group by authentication state: public paths, no token, invalid token, valid token
- Group by route type: pages vs APIs
- Group by functionality: CORS, logging, edge cases

---

## Test File Structure

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { NextRequest } from 'next/server';
import { middleware } from './middleware';
import * as jwt from '@/lib/auth/jwt';

// Module-level mocks
vi.mock('@/lib/auth/jwt', () => ({
  verifyToken: vi.fn(),
}));

const mockConsoleLog = vi.spyOn(console, 'log').mockImplementation(() => {});

// Helper function for creating mock requests
function createMockRequest(
  pathname: string,
  options: { method?: string; token?: string; origin?: string } = {}
): NextRequest {
  const url = `http://localhost:3000${pathname}`;
  const headers = new Headers();

  if (options.token) {
    headers.set('cookie', `auth-token=${options.token}`);
  }

  if (options.origin) {
    headers.set('origin', options.origin);
  }

  return new NextRequest(url, {
    method: options.method || 'GET',
    headers,
  });
}

describe('Middleware Integration Tests', () => {
  beforeEach(() => {
    vi.clearAllMocks(); // Clear mock call history between tests
  });

  describe('Public Paths (AC2)', () => {
    // 1.8-INT-001 to 1.8-INT-004
  });

  describe('OPTIONS Requests (AC7)', () => {
    // 1.8-INT-005
  });

  describe('Protected Routes - No Token (AC3, AC4)', () => {
    // 1.8-INT-006 to 1.8-INT-008
  });

  describe('Protected Routes - Invalid Token (AC6)', () => {
    // 1.8-INT-009 to 1.8-INT-011
  });

  describe('Protected Routes - Valid Token (AC5)', () => {
    // 1.8-INT-012 to 1.8-INT-013
  });

  describe('CORS Origin Validation (AC8)', () => {
    // 1.8-INT-014 to 1.8-INT-016
  });

  describe('Response Headers (AC10)', () => {
    // 1.8-INT-017
  });

  describe('Request Logging (AC9)', () => {
    // 1.8-INT-018
  });

  describe('Edge Cases - Path Matching', () => {
    // 1.8-INT-019 to 1.8-INT-020
  });
});
```

---

## Coverage Validation Strategy

### Target Metrics

- **Line Coverage:** 95%+ for `middleware.ts`
- **Branch Coverage:** 95%+ for all conditional logic
- **Function Coverage:** 100% (only one exported function)
- **Statement Coverage:** 95%+ for all executable statements

### Coverage Verification Process

1. Run `pnpm test:coverage -- middleware.test.ts`
2. Open `coverage/index.html` in browser
3. Navigate to `middleware.ts` file
4. Verify all authentication paths highlighted green (covered)
5. Document any uncovered lines with justification
6. Add `/* istanbul ignore next */` for intentionally uncovered code

### Expected Uncovered Lines (if any)

- Console.log statements (mocked, not testing log format details)
- Defensive error handling for impossible states
- Future feature flags (if present)

---

## Performance Optimization Techniques

### Mock Creation Optimization

- **Reusable helper:** `createMockRequest()` minimizes object construction overhead
- **Minimal headers:** Only set required headers (cookie, origin) when needed
- **Shared URL base:** Consistent base URL reduces string manipulation

### Mock Management Optimization

- **Clear vs Restore:** Use `vi.clearAllMocks()` (fast) instead of `vi.restoreAllMocks()` (slow)
- **Targeted clearing:** Clear only in beforeEach, not afterEach
- **Mock state reuse:** Group tests by mock state to reduce setup overhead

### Async/Await Optimization

- **Synchronous assertions:** No async/await for status/header checks
- **Minimal JSON parsing:** Only parse response body when verifying error messages
- **Parallel execution:** Vitest default parallel mode enabled

### Test Grouping Optimization

- **Nested describe blocks:** Share mock setup for tests with identical preconditions
- **Sequential ordering:** Run fastest tests first for immediate feedback

### Expected Performance

- **Target:** <10 seconds for all 20 tests
- **Average:** ~0.5 seconds per test
- **Fast tests:** Public path tests (0.3s each)
- **Slower tests:** JWT mocking tests (0.7s each)

---

## Test Maintenance Strategy

### Future Test Additions

When adding new middleware functionality:

1. **Add integration test** for new component interaction
2. **Verify coverage** remains above 95%
3. **Check performance** - new tests must not exceed budget
4. **Update test design** document with new scenarios

### Test Naming Convention

- **Format:** `should {expected behavior} ({TEST-ID})`
- **Example:** `should redirect to /login when no token present (1.8-INT-006)`
- **Benefits:** Clear intent, traceability to AC, easy debugging

### Mock Management Best Practices

- **Document mock behavior:** Comment expected return values
- **Verify mock calls:** Always assert `verifyToken` called/not called as appropriate
- **Clear mock state:** Use beforeEach to prevent test pollution
- **Avoid over-mocking:** Mock only external dependencies (JWT), not middleware internals

---

## Quality Checklist

Before finalizing test implementation, verify:

- [x] Every AC has test coverage (ACs 2-10 covered, ACs 1/11-14 are meta-criteria)
- [x] Test levels are appropriate (all integration tests, no over-testing with E2E)
- [x] No duplicate coverage across levels (no unit tests for same logic)
- [x] Priorities align with business risk (P0 for security, P1 for operations)
- [x] Test IDs follow naming convention (1.8-INT-###)
- [x] Scenarios are atomic and independent (each test creates own request)
- [x] Performance target achievable (<10s for 20 tests)
- [x] Coverage target achievable (95%+ with 20 comprehensive tests)
- [x] All critical risks mitigated (SEC-001, PERF-001)

---

## Acceptance Criteria Coverage Summary

| AC# | Requirement                                     | Test Coverage                      | Status |
| --- | ----------------------------------------------- | ---------------------------------- | ------ |
| 1   | Create middleware.test.ts with 20 tests         | All 20 tests specified below       | ✅     |
| 2   | Public paths bypass authentication              | 1.8-INT-001 to 1.8-INT-004         | ✅     |
| 3   | Protected pages redirect to /login (303)        | 1.8-INT-006 to 1.8-INT-007         | ✅     |
| 4   | Protected APIs return 401 JSON                  | 1.8-INT-008                        | ✅     |
| 5   | Valid tokens allow access (NextResponse.next()) | 1.8-INT-012 to 1.8-INT-013         | ✅     |
| 6   | Invalid/expired tokens trigger failure          | 1.8-INT-009 to 1.8-INT-011         | ✅     |
| 7   | OPTIONS requests return 200 with CORS           | 1.8-INT-005                        | ✅     |
| 8   | CORS origin validation tested                   | 1.8-INT-014 to 1.8-INT-016         | ✅     |
| 9   | Request logging verified                        | 1.8-INT-018                        | ✅     |
| 10  | x-middleware-cache header set                   | 1.8-INT-017                        | ✅     |
| 11  | Package.json "type": "module" added             | Manual verification (Task 1)       | ✅     |
| 12  | No Vite warnings during test execution          | Manual verification (Task 1)       | ✅     |
| 13  | Coverage reaches 95%+                           | Metric verification (Task 13)      | ✅     |
| 14  | Test execution <10 seconds                      | Performance verification (Task 13) | ✅     |

**Total Coverage:** 14/14 ACs covered (100%)

---

## Test Traceability Matrix

### Story 1.8 → Test Scenarios

| AC   | Requirement                    | Test IDs                           | Test Count |
| ---- | ------------------------------ | ---------------------------------- | ---------- |
| 2    | Public paths bypass auth       | INT-001, INT-002, INT-003, INT-004 | 4          |
| 3    | Protected pages redirect       | INT-006, INT-007                   | 2          |
| 4    | Protected APIs return 401      | INT-008                            | 1          |
| 5    | Valid tokens allow access      | INT-012, INT-013                   | 2          |
| 6    | Invalid tokens trigger failure | INT-009, INT-010, INT-011          | 3          |
| 7    | OPTIONS requests return 200    | INT-005                            | 1          |
| 8    | CORS origin validation         | INT-014, INT-015, INT-016          | 3          |
| 9    | Request logging                | INT-018                            | 1          |
| 10   | Cache control header           | INT-017                            | 1          |
| Edge | Edge case path matching        | INT-019, INT-020                   | 2          |

**Total:** 20 integration test scenarios

---

## Conclusion

This test design provides **comprehensive integration test coverage** for Story 1.8 with:

- **20 integration tests** covering all middleware functionality
- **Zero redundancy** - appropriate test level selection (no over-testing)
- **Risk-based prioritization** - 85% P0 tests for critical security paths
- **Performance-optimized** - patterns designed for <10 second execution
- **Complete AC coverage** - 100% of acceptance criteria tested

**Key Success Metrics:**

- ✅ 95%+ coverage target achievable with 20 tests
- ✅ <10 second performance target achievable with optimized patterns
- ✅ All critical security risks (SEC-001) directly mitigated
- ✅ No duplicate test coverage across levels

**Recommended Next Steps:**

1. Implement tests in execution order (P0 first, P1 last)
2. Verify coverage after each test batch
3. Monitor performance continuously during implementation
4. Update risk profile as tests are completed
