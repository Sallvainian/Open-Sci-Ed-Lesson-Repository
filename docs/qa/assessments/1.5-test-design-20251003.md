# Test Design: Story 1.5 - Basic Authentication Implementation

Date: 2025-10-03
Designer: Quinn (Test Architect)

## Test Strategy Overview

- **Total Test Scenarios**: 47
- **Unit Tests**: 18 (38%)
- **Integration Tests**: 21 (45%)
- **E2E Tests**: 8 (17%)
- **Priority Distribution**: P0: 15 | P1: 20 | P2: 9 | P3: 3

**Test Philosophy**: Security-first with comprehensive coverage of authentication critical path. Heavy emphasis on integration testing for auth flow validation. E2E tests for critical user journeys only.

---

## Test Scenarios by Acceptance Criteria

### AC1: Login page created with username/password form fields

#### Scenarios

| ID           | Level       | Priority | Test Description                         | Justification                     | Mitigates Risk |
| ------------ | ----------- | -------- | ---------------------------------------- | --------------------------------- | -------------- |
| 1.5-UNIT-001 | Unit        | P1       | Form renders username input field        | Component rendering logic         | -              |
| 1.5-UNIT-002 | Unit        | P1       | Form renders password input field        | Component rendering logic         | -              |
| 1.5-UNIT-003 | Unit        | P1       | Password field has type="password"       | Security: visual masking          | SEC-004        |
| 1.5-INT-001  | Integration | P0       | Login page accessible at /login route    | Routing configuration critical    | -              |
| 1.5-INT-002  | Integration | P1       | Form has proper labels for accessibility | WCAG compliance                   | -              |
| 1.5-E2E-001  | E2E         | P1       | User can navigate to login page          | Critical user journey entry point | -              |

**Coverage**: 6 tests across 3 levels
**Focus**: Accessibility, security (password masking), routing

---

### AC2: Backend endpoint implemented: POST /api/auth/login

#### Scenarios

| ID           | Level       | Priority | Test Description                             | Justification                          | Mitigates Risk |
| ------------ | ----------- | -------- | -------------------------------------------- | -------------------------------------- | -------------- |
| 1.5-UNIT-004 | Unit        | P0       | Login route accepts POST request             | HTTP method handling                   | -              |
| 1.5-UNIT-005 | Unit        | P0       | Request body parsed as JSON                  | Data parsing logic                     | -              |
| 1.5-INT-003  | Integration | P0       | Endpoint returns 200 for valid credentials   | Core authentication success path       | -              |
| 1.5-INT-004  | Integration | P0       | Endpoint returns 401 for invalid credentials | Core authentication failure path       | SEC-005        |
| 1.5-INT-005  | Integration | P0       | Endpoint validates request body with Zod     | Input validation critical for security | SEC-004        |
| 1.5-INT-006  | Integration | P1       | Endpoint returns 400 for malformed JSON      | Error handling robustness              | SEC-004        |
| 1.5-INT-007  | Integration | P2       | Endpoint handles OPTIONS for CORS preflight  | Browser compatibility                  | -              |

**Coverage**: 7 tests (2 unit, 5 integration)
**Focus**: HTTP protocol, validation, error handling

---

### AC3: Password securely hashed and validated

#### Scenarios

| ID           | Level       | Priority | Test Description                                      | Justification                   | Mitigates Risk |
| ------------ | ----------- | -------- | ----------------------------------------------------- | ------------------------------- | -------------- |
| 1.5-UNIT-006 | Unit        | P0       | Password hashing produces different hash each time    | Proper salt usage               | SEC-002        |
| 1.5-UNIT-007 | Unit        | P0       | Password verification returns true for valid password | Core security function          | SEC-002        |
| 1.5-UNIT-008 | Unit        | P0       | Password verification returns false for invalid       | Core security function          | SEC-002        |
| 1.5-UNIT-009 | Unit        | P0       | Hashing uses SALT_ROUNDS = 10                         | Security best practice          | SEC-002        |
| 1.5-UNIT-010 | Unit        | P1       | bcrypt.compare is timing-safe                         | Timing attack resistance        | SEC-002        |
| 1.5-INT-008  | Integration | P0       | Hardcoded user credential hash validates correctly    | Credential storage verification | SEC-002        |
| 1.5-INT-009  | Integration | P1       | Password never logged in server logs                  | Prevent credential leakage      | SEC-002        |

**Coverage**: 7 tests (5 unit, 2 integration)
**Focus**: Cryptographic correctness, timing attacks, credential security

---

### AC4: Authentication returns JWT token with 8-hour expiration

#### Scenarios

| ID           | Level       | Priority | Test Description                               | Justification                   | Mitigates Risk |
| ------------ | ----------- | -------- | ---------------------------------------------- | ------------------------------- | -------------- |
| 1.5-UNIT-011 | Unit        | P0       | JWT token generation produces valid token      | Core authentication mechanism   | SEC-001        |
| 1.5-UNIT-012 | Unit        | P0       | Token verification decodes valid token         | Core authentication mechanism   | SEC-001        |
| 1.5-UNIT-013 | Unit        | P0       | Token includes userId and username in payload  | Required claims present         | -              |
| 1.5-UNIT-014 | Unit        | P0       | Token expiration set to 8 hours                | Meets AC requirement            | TECH-001       |
| 1.5-UNIT-015 | Unit        | P0       | Expired token verification returns null        | Security: reject expired tokens | TECH-001       |
| 1.5-UNIT-016 | Unit        | P1       | Invalid token verification returns null        | Security: reject forged tokens  | SEC-001        |
| 1.5-INT-010  | Integration | P0       | Login response includes token in response body | Token delivery mechanism        | -              |
| 1.5-INT-011  | Integration | P0       | Login response includes user object            | Client needs user info          | -              |

**Coverage**: 8 tests (6 unit, 2 integration)
**Focus**: JWT correctness, expiration handling, token security

---

### AC5: Frontend stores authentication token securely (httpOnly cookie)

#### Scenarios

| ID          | Level       | Priority | Test Description                                 | Justification                      | Mitigates Risk |
| ----------- | ----------- | -------- | ------------------------------------------------ | ---------------------------------- | -------------- |
| 1.5-INT-012 | Integration | P0       | Login sets httpOnly cookie                       | XSS protection (critical security) | SEC-003        |
| 1.5-INT-013 | Integration | P0       | Cookie has secure flag in production             | HTTPS-only transmission            | SEC-003        |
| 1.5-INT-014 | Integration | P0       | Cookie has sameSite='lax' for CSRF protection    | CSRF mitigation                    | SEC-003        |
| 1.5-INT-015 | Integration | P0       | Cookie maxAge matches token expiration (8 hours) | Consistent session duration        | DATA-001       |
| 1.5-INT-016 | Integration | P0       | Cookie path set to '/' for app-wide access       | Cookie availability across routes  | DATA-001       |
| 1.5-INT-017 | Integration | P1       | Cookie not accessible via document.cookie        | Verify httpOnly enforcement        | SEC-003        |
| 1.5-E2E-002 | E2E         | P0       | Token not exposed in client JavaScript           | End-to-end XSS protection          | SEC-003        |

**Coverage**: 7 tests (6 integration, 1 E2E)
**Focus**: Cookie security attributes, XSS protection

---

### AC6: Protected routes require valid authentication token

#### Scenarios

| ID           | Level       | Priority | Test Description                                     | Justification                         | Mitigates Risk |
| ------------ | ----------- | -------- | ---------------------------------------------------- | ------------------------------------- | -------------- |
| 1.5-UNIT-017 | Unit        | P0       | Middleware extracts token from Authorization header  | Token extraction logic                | -              |
| 1.5-UNIT-018 | Unit        | P0       | Middleware extracts token from cookies               | Token extraction logic                | -              |
| 1.5-INT-018  | Integration | P0       | Protected route returns 401 for missing token        | Core authorization check              | -              |
| 1.5-INT-019  | Integration | P0       | Protected route returns 401 for invalid token        | Core authorization check              | SEC-001        |
| 1.5-INT-020  | Integration | P0       | Protected route returns 401 for expired token        | Core authorization check              | TECH-001       |
| 1.5-INT-021  | Integration | P0       | Protected route allows access with valid token       | Core authorization success path       | -              |
| 1.5-INT-022  | Integration | P1       | Middleware attaches user info to request             | User context propagation              | -              |
| 1.5-INT-023  | Integration | P2       | All API routes (disciplines/units/lessons) protected | Comprehensive protection coverage     | -              |
| 1.5-E2E-003  | E2E         | P0       | Unauthenticated API request blocked                  | End-to-end authorization verification | -              |

**Coverage**: 9 tests (2 unit, 6 integration, 1 E2E)
**Focus**: Authorization enforcement, token validation

---

### AC7: Frontend redirects unauthenticated users to login

#### Scenarios

| ID          | Level       | Priority | Test Description                                    | Justification                            | Mitigates Risk |
| ----------- | ----------- | -------- | --------------------------------------------------- | ---------------------------------------- | -------------- |
| 1.5-INT-024 | Integration | P0       | Middleware redirects to /login for missing token    | Route protection mechanism               | -              |
| 1.5-INT-025 | Integration | P0       | Middleware redirects to /login for invalid token    | Route protection mechanism               | -              |
| 1.5-INT-026 | Integration | P1       | Public routes (/login, /api/auth/\*) not protected  | Allow public access to auth endpoints    | -              |
| 1.5-INT-027 | Integration | P1       | Middleware config matcher excludes \_next assets    | Performance: skip auth for static assets | TECH-002       |
| 1.5-E2E-004 | E2E         | P0       | Accessing protected page redirects to login         | Critical user flow                       | -              |
| 1.5-E2E-005 | E2E         | P1       | After login, redirects to originally requested page | User experience optimization             | -              |

**Coverage**: 6 tests (4 integration, 2 E2E)
**Focus**: Route protection, redirect logic, UX

---

### AC8: Logout functionality clears authentication token

#### Scenarios

| ID          | Level       | Priority | Test Description                         | Justification             | Mitigates Risk |
| ----------- | ----------- | -------- | ---------------------------------------- | ------------------------- | -------------- |
| 1.5-INT-028 | Integration | P0       | Logout endpoint clears auth-token cookie | Core logout mechanism     | -              |
| 1.5-INT-029 | Integration | P0       | Logout returns success response          | Client needs confirmation | -              |
| 1.5-INT-030 | Integration | P1       | Logout endpoint accepts POST method      | HTTP method correctness   | -              |
| 1.5-E2E-006 | E2E         | P0       | Logout button visible when authenticated | UI component presence     | -              |
| 1.5-E2E-007 | E2E         | P0       | Clicking logout redirects to login page  | Complete logout flow      | -              |

**Coverage**: 5 tests (3 integration, 2 E2E)
**Focus**: Logout mechanism, cookie clearing, UI integration

---

### AC9: User remains authenticated across browser refresh

#### Scenarios

| ID          | Level       | Priority | Test Description                                | Justification                    | Mitigates Risk |
| ----------- | ----------- | -------- | ----------------------------------------------- | -------------------------------- | -------------- |
| 1.5-INT-031 | Integration | P0       | Cookie persists with maxAge=8 hours             | Cookie persistence configuration | DATA-001       |
| 1.5-INT-032 | Integration | P1       | Token verified on page load from cookie         | Session restoration logic        | DATA-001       |
| 1.5-INT-033 | Integration | P2       | Auth state restored from valid cookie           | Client-side state management     | DATA-001       |
| 1.5-E2E-008 | E2E         | P0       | Browser refresh maintains authenticated session | Critical UX requirement          | DATA-001       |

**Coverage**: 4 tests (3 integration, 1 E2E)
**Focus**: Session persistence, cookie lifetime

---

### AC10: Login with correct credentials grants access; incorrect returns error

#### Scenarios

| ID          | Level       | Priority | Test Description                                      | Justification                | Mitigates Risk |
| ----------- | ----------- | -------- | ----------------------------------------------------- | ---------------------------- | -------------- |
| 1.5-INT-034 | Integration | P0       | Valid credentials return 200 and token                | Success path verification    | -              |
| 1.5-INT-035 | Integration | P0       | Invalid username returns 401 with generic error       | Prevent username enumeration | SEC-005        |
| 1.5-INT-036 | Integration | P0       | Invalid password returns 401 with generic error       | Prevent username enumeration | SEC-005        |
| 1.5-INT-037 | Integration | P0       | Error message identical for username/password errors  | Timing-safe error responses  | SEC-005        |
| 1.5-INT-038 | Integration | P1       | Client displays error message for invalid credentials | User feedback mechanism      | -              |
| 1.5-INT-039 | Integration | P1       | Successful login redirects to home page               | Success flow completion      | -              |

**Coverage**: 6 tests (all integration)
**Focus**: Success/failure paths, error message security

---

## Additional Security Test Scenarios

### Input Validation and Security

| ID          | Level       | Priority | Test Description                                 | Justification                   | Mitigates Risk |
| ----------- | ----------- | -------- | ------------------------------------------------ | ------------------------------- | -------------- |
| 1.5-INT-040 | Integration | P0       | SQL injection in username field blocked          | Critical security vulnerability | SEC-004        |
| 1.5-INT-041 | Integration | P0       | XSS payload in username field sanitized          | Critical security vulnerability | SEC-004        |
| 1.5-INT-042 | Integration | P1       | Extremely long username (>1000 chars) rejected   | DoS prevention                  | SEC-004        |
| 1.5-INT-043 | Integration | P1       | Extremely long password (>1000 chars) rejected   | DoS prevention                  | SEC-004        |
| 1.5-INT-044 | Integration | P2       | Unicode and special characters handled correctly | International support           | SEC-004        |
| 1.5-INT-045 | Integration | P3       | Empty username/password rejected                 | Basic validation                | SEC-004        |

**Coverage**: 6 integration tests
**Focus**: Input validation, injection prevention, DoS protection

---

### Performance and Operational

| ID          | Level       | Priority | Test Description                 | Justification   | Mitigates Risk |
| ----------- | ----------- | -------- | -------------------------------- | --------------- | -------------- |
| 1.5-INT-046 | Integration | P2       | Login response time < 1 second   | Performance SLA | PERF-001       |
| 1.5-INT-047 | Integration | P3       | Middleware execution time < 50ms | Performance SLA | TECH-002       |

**Coverage**: 2 integration tests
**Focus**: Performance benchmarks

---

## Risk Coverage Matrix

| Risk ID  | Test Coverage                                  | Coverage Level |
| -------- | ---------------------------------------------- | -------------- |
| SEC-001  | 1.5-UNIT-011, 012, 016, INT-019                | Comprehensive  |
| SEC-002  | 1.5-UNIT-006 through 010, INT-008, 009         | Comprehensive  |
| SEC-003  | 1.5-INT-012 through 017, E2E-002               | Comprehensive  |
| SEC-004  | 1.5-INT-005, 006, 040, 041, 042, 043, 044, 045 | Comprehensive  |
| SEC-005  | 1.5-INT-004, 035, 036, 037                     | Comprehensive  |
| PERF-001 | 1.5-INT-046                                    | Basic          |
| TECH-001 | 1.5-UNIT-014, 015, INT-020                     | Adequate       |
| DATA-001 | 1.5-INT-015, 016, 031, 032, 033, E2E-008       | Comprehensive  |
| TECH-002 | 1.5-INT-027, 047                               | Basic          |
| OPS-001  | Manual verification (logging)                  | Out of scope   |
| OPS-002  | Documented behavior (no blacklist)             | Accepted risk  |
| BUS-001  | 1.5-INT-008 (hardcoded credential works)       | Adequate       |

**Total Risk Coverage**: 10/12 risks have explicit test coverage (83%)
**Gaps**: OPS-001 (monitoring - future), OPS-002 (accepted architectural limitation)

---

## Test Organization and Execution

### Test File Locations

**Unit Tests**:

- `lib/auth/jwt.test.ts` - JWT generation and verification (1.5-UNIT-011 through 016)
- `lib/auth/password.test.ts` - Password hashing and verification (1.5-UNIT-006 through 010)
- `lib/auth/middleware.test.ts` - Token extraction logic (1.5-UNIT-017, 018)
- `app/login/page.test.tsx` - Login form component (1.5-UNIT-001 through 003)
- `app/api/auth/login/route.test.ts` - Login endpoint logic (1.5-UNIT-004, 005)

**Integration Tests**:

- `app/api/auth/login/route.integration.test.ts` - Login API flow (1.5-INT-003 through 011, 034 through 047)
- `app/api/auth/logout/route.integration.test.ts` - Logout API flow (1.5-INT-028 through 030)
- `middleware.integration.test.ts` - Route protection (1.5-INT-001, 018 through 027, 031 through 033)
- `lib/auth/auth-flow.integration.test.ts` - Cookie management (1.5-INT-012 through 017)

**E2E Tests**:

- `tests/e2e/auth.spec.ts` - Complete authentication flows (1.5-E2E-001 through 008)

---

### Recommended Execution Order

**Phase 1: Fast Feedback (Unit Tests) - ~2 minutes**

1. P0 Unit tests (1.5-UNIT-004 through 018) - Critical logic verification
2. P1 Unit tests (1.5-UNIT-001 through 003) - Component rendering

**Phase 2: Integration Validation - ~5 minutes**

1. P0 Integration tests (1.5-INT-003, 004, 005, 008, 010, 011, 012, 013, 014, 015, 016, 018, 019, 020, 021, 024, 025, 028, 029, 031, 034, 035, 036, 037, 040, 041)
2. P1 Integration tests (remaining)
3. P2/P3 Integration tests (if time permits)

**Phase 3: End-to-End Verification - ~3 minutes**

1. P0 E2E tests (1.5-E2E-002, 003, 004, 006, 007, 008) - Critical user journeys
2. P1 E2E tests (1.5-E2E-001, 005) - Secondary flows

**Total Estimated Execution Time**: ~10 minutes (all tests)
**CI Pipeline**: Run P0 tests on every commit, full suite on PR

---

## Test Coverage Goals

### By Component

| Component                    | Unit Coverage | Integration Coverage | E2E Coverage |
| ---------------------------- | ------------- | -------------------- | ------------ |
| lib/auth/jwt.ts              | 95%           | -                    | -            |
| lib/auth/password.ts         | 95%           | -                    | -            |
| lib/auth/middleware.ts       | 85%           | 90%                  | -            |
| app/api/auth/login/route.ts  | 80%           | 95%                  | -            |
| app/api/auth/logout/route.ts | 80%           | 90%                  | -            |
| app/login/page.tsx           | 70%           | 80%                  | 90%          |
| middleware.ts                | -             | 90%                  | 80%          |

**Overall Coverage Target**: 85% (security-critical components: 90%+)

---

### By Acceptance Criteria

| AC  | Coverage | P0 Tests | P1 Tests | Risk Coverage     |
| --- | -------- | -------- | -------- | ----------------- |
| 1   | 100%     | 1        | 5        | SEC-004           |
| 2   | 100%     | 5        | 2        | SEC-004, SEC-005  |
| 3   | 100%     | 6        | 1        | SEC-002           |
| 4   | 100%     | 6        | 2        | SEC-001, TECH-001 |
| 5   | 100%     | 6        | 1        | SEC-003, DATA-001 |
| 6   | 100%     | 6        | 2        | SEC-001, TECH-001 |
| 7   | 100%     | 3        | 3        | TECH-002          |
| 8   | 100%     | 4        | 1        | -                 |
| 9   | 100%     | 2        | 2        | DATA-001          |
| 10  | 100%     | 4        | 2        | SEC-005           |

**AC Coverage**: 10/10 ACs have comprehensive test coverage (100%)

---

## Test Data Requirements

### Hardcoded Test User

```typescript
// For testing purposes
const TEST_USER = {
  id: 'test-user-1',
  username: 'testuser',
  password: 'Test123!@#', // Raw password for test
  hashedPassword: '$2a$10$...', // bcrypt hash for verification tests
};
```

### Test JWT Secrets

```typescript
// Development/Test JWT Secret
const TEST_JWT_SECRET = 'test-secret-key-at-least-32-chars-long-12345';

// NEVER use in production
```

### Test Tokens

```typescript
// Valid token (not expired)
const VALID_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';

// Expired token (past 8 hours)
const EXPIRED_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';

// Invalid token (malformed)
const INVALID_TOKEN = 'invalid.token.here';
```

### Test Input Payloads

```typescript
// SQL Injection attempts
const SQL_INJECTION_PAYLOADS = ["admin' OR '1'='1", "'; DROP TABLE users; --", "admin'--"];

// XSS attempts
const XSS_PAYLOADS = [
  '<script>alert("XSS")</script>',
  '<img src=x onerror=alert("XSS")>',
  'javascript:alert("XSS")',
];

// Long inputs (DoS)
const LONG_INPUT = 'a'.repeat(10000);
```

---

## Test Environment Configuration

### Required Environment Variables

```bash
# Testing
NODE_ENV=test
JWT_SECRET=test-secret-key-at-least-32-chars-long-12345

# Database (future - not needed for MVP)
# DATABASE_URL=postgresql://test:test@localhost:5432/testdb
```

### Test Dependencies

```json
{
  "devDependencies": {
    "@testing-library/react": "^14.0.0",
    "@testing-library/user-event": "^14.0.0",
    "@vitejs/plugin-react": "^4.0.0",
    "vitest": "^1.0.0",
    "supertest": "^6.3.0", // For API testing
    "@playwright/test": "^1.40.0" // For E2E testing
  }
}
```

---

## Quality Checklist

✅ **Coverage Validation**:

- [x] Every AC has test coverage (10/10 = 100%)
- [x] All critical risks have test coverage (5/5 critical + high risks)
- [x] Test levels are appropriate (38% unit, 45% integration, 17% E2E)
- [x] No duplicate coverage identified

✅ **Test Design Quality**:

- [x] Test IDs follow naming convention (1.5-{LEVEL}-{SEQ})
- [x] Scenarios are atomic and independent
- [x] Priorities align with business/security risk
- [x] Justifications provided for all tests

✅ **Risk Alignment**:

- [x] Security risks (SEC-001 through SEC-005) comprehensively covered
- [x] Performance risks (PERF-001) have benchmark tests
- [x] Data risks (DATA-001) covered in persistence tests
- [x] Technical risks (TECH-001, TECH-002) adequately addressed

✅ **Execution Strategy**:

- [x] Fast feedback with unit tests first (Phase 1)
- [x] Integration validation second (Phase 2)
- [x] E2E verification last (Phase 3)
- [x] Total execution time reasonable (~10 minutes)

---

## Success Criteria

### Definition of Done for Testing

1. ✅ All P0 tests passing (43 tests)
2. ✅ All P1 tests passing (20 tests)
3. ✅ Code coverage >85% overall, >90% for security components
4. ✅ All critical security risks (SEC-001 through SEC-005) validated
5. ✅ E2E tests pass in CI environment
6. ✅ No security vulnerabilities detected in dependency scan
7. ✅ Performance benchmarks met (login <1s, middleware <50ms)

### Gate Criteria

**PASS Requirements**:

- All P0 tests green
- No critical security test failures
- Coverage targets met
- Performance benchmarks achieved

**CONCERNS Triggers**:

- P0 tests passing but P1 failures
- Coverage below target but >70%
- Performance slightly below benchmark

**FAIL Triggers**:

- Any P0 test failures
- Critical security test failures
- Coverage <70%
- Performance significantly below benchmark

---

## Recommendations

### Immediate Actions

1. **Implement P0 unit tests first** (fast feedback loop)
2. **Security testing priority**: SEC-001 through SEC-005 before any deployment
3. **Set up CI pipeline** to run tests on every commit
4. **Code coverage monitoring** integrated into PR process

### Future Enhancements

1. **Rate Limiting Tests**: When rate limiting implemented (OPS-001 mitigation)
2. **Token Refresh Tests**: When token refresh mechanism added
3. **Multi-User Tests**: When database-backed users replace hardcoded credential
4. **Performance Load Tests**: Concurrent user authentication scenarios
5. **Security Audit**: Professional penetration testing after MVP

### Monitoring Integration

1. **Test Results Dashboard**: Track test execution trends
2. **Coverage Trends**: Monitor coverage over time
3. **Flaky Test Detection**: Identify unreliable tests
4. **Performance Regression**: Alert on benchmark failures

---

## Summary

**Test Strategy**: Comprehensive security-first testing with 47 scenarios across 3 levels. Heavy emphasis on integration testing (45%) for authentication flow validation, with targeted E2E tests (17%) for critical user journeys. All 10 acceptance criteria have 100% coverage, and all critical security risks are thoroughly tested.

**Execution Time**: ~10 minutes for full suite, ~5 minutes for P0 tests only

**Coverage Goals**: 85% overall, 90%+ for security-critical components

**Risk Mitigation**: 10/12 identified risks have explicit test coverage (83%)

**Quality Assurance**: 43 P0 tests ensure critical functionality and security requirements are validated before any deployment.
