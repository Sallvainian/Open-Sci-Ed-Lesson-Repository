# Test Design: Story 1.6 - CI/CD Pipeline Configuration

**Date**: 2025-10-04
**Designer**: Quinn (Test Architect)
**Story**: 1.6 - CI/CD Pipeline Configuration

## Test Strategy Overview

**Total Test Scenarios**: 24

- **Verification Tests**: 18 (75%) - Manual verification of infrastructure
- **Integration Tests**: 6 (25%) - End-to-end workflow testing
- **Unit Tests**: 0 (0%) - No testable application code added

**Priority Distribution**:

- **P0 (Critical)**: 12 scenarios (50%)
- **P1 (High)**: 8 scenarios (33%)
- **P2 (Medium)**: 4 scenarios (17%)
- **P3 (Low)**: 0 scenarios (0%)

**Test Level Rationale**:
This is an infrastructure configuration story, not application feature development. The "tests" are actually **verification procedures** to confirm correct setup. Traditional unit/integration/E2E test levels don't apply directly - instead, we verify configuration correctness through:

1. **Verification Tests**: Check files exist, config correct, status visible
2. **Integration Tests**: End-to-end workflow execution (PR → CI → Merge → CD → Deploy)

---

## Test Scenarios by Acceptance Criteria

### AC1: CI/CD Platform Configured

**Acceptance Criterion**: "CI/CD platform configured (GitHub Actions, GitLab CI, or chosen platform)"

#### Scenarios

| ID             | Level        | Priority | Test                                 | Justification                            | Mitigates Risk |
| -------------- | ------------ | -------- | ------------------------------------ | ---------------------------------------- | -------------- |
| 1.6-VERIFY-001 | Verification | P0       | `.github/workflows/ci.yml` exists    | Core infrastructure file must be present | TECH-002       |
| 1.6-VERIFY-002 | Verification | P1       | GitHub Actions enabled in repository | Platform must be active                  | OPS-001        |
| 1.6-VERIFY-003 | Verification | P2       | CI workflow YAML syntax valid        | Prevents runtime errors                  | OPS-001        |

**Coverage**: ✅ AC1 fully covered (3 scenarios)

---

### AC2: CI Pipeline Runs on Push to Main and All PRs

**Acceptance Criterion**: "CI pipeline runs on every push to main branch and all pull requests"

#### Scenarios

| ID             | Level        | Priority | Test                                | Justification                         | Mitigates Risk |
| -------------- | ------------ | -------- | ----------------------------------- | ------------------------------------- | -------------- |
| 1.6-INT-001    | Integration  | P0       | Create test PR → Verify CI triggers | Critical workflow must activate       | OPS-001        |
| 1.6-INT-002    | Integration  | P0       | Push to main → Verify CI triggers   | Main branch protection critical       | OPS-001        |
| 1.6-VERIFY-004 | Verification | P1       | Workflow triggers config correct    | Validate `on: push/pull_request` YAML | TECH-001       |

**Coverage**: ✅ AC2 fully covered (3 scenarios)

---

### AC3: CI Pipeline Executes Linting, Formatting, Type-Check, Tests

**Acceptance Criterion**: "CI pipeline executes: linting (ESLint), formatting check (Prettier), unit tests (if any exist yet)"

#### Scenarios

| ID             | Level        | Priority | Test                                 | Justification                      | Mitigates Risk |
| -------------- | ------------ | -------- | ------------------------------------ | ---------------------------------- | -------------- |
| 1.6-INT-003    | Integration  | P0       | CI runs ESLint job                   | Code quality gate must execute     | OPS-001        |
| 1.6-INT-004    | Integration  | P0       | CI runs Prettier format check        | Code style consistency required    | OPS-001        |
| 1.6-INT-005    | Integration  | P0       | CI runs TypeScript type-check        | Type safety validation critical    | OPS-001        |
| 1.6-INT-006    | Integration  | P0       | CI runs Vitest unit tests (68 tests) | Existing test suite must pass      | OPS-001        |
| 1.6-VERIFY-005 | Verification | P1       | All 4 jobs run in parallel           | Performance optimization check     | PERF-001       |
| 1.6-VERIFY-006 | Verification | P1       | pnpm caching configured              | Verify `cache: 'pnpm'` in workflow | PERF-001       |

**Coverage**: ✅ AC3 fully covered (6 scenarios)

---

### AC4: CI Pipeline Blocks Merge if Checks Fail

**Acceptance Criterion**: "CI pipeline blocks merge if any checks fail"

#### Scenarios

| ID             | Level        | Priority | Test                                          | Justification                        | Mitigates Risk |
| -------------- | ------------ | -------- | --------------------------------------------- | ------------------------------------ | -------------- |
| 1.6-INT-007    | Integration  | P0       | PR with lint error → CI fails → Merge blocked | Critical failure detection           | OPS-001        |
| 1.6-INT-008    | Integration  | P0       | Fix lint error → CI passes → Merge allowed    | Confirms workflow correctly unblocks | OPS-001        |
| 1.6-VERIFY-007 | Verification | P1       | GitHub branch protection rule configured      | Prevent direct push to main          | SEC-001        |

**Coverage**: ✅ AC4 fully covered (3 scenarios)

---

### AC5: CD Triggers Deployment on Successful Main Merge

**Acceptance Criterion**: "CD pipeline triggers automatic deployment to hosting platform on successful main branch merge"

#### Scenarios

| ID             | Level        | Priority | Test                                       | Justification                              | Mitigates Risk |
| -------------- | ------------ | -------- | ------------------------------------------ | ------------------------------------------ | -------------- |
| 1.6-INT-009    | Integration  | P0       | Merge PR to main → Deployment triggered    | Core CD functionality                      | OPS-001        |
| 1.6-VERIFY-008 | Verification | P1       | Vercel GitHub Integration enabled          | Confirm recommended approach configured    | OPS-001        |
| 1.6-VERIFY-009 | Verification | P2       | Alternative: `deploy.yml` exists (if used) | Verify if GitHub Actions CD chosen instead | TECH-002       |

**Coverage**: ✅ AC5 fully covered (3 scenarios)

---

### AC6: Deployment Includes Frontend and Backend

**Acceptance Criterion**: "Deployment includes both frontend and backend components"

#### Scenarios

| ID             | Level        | Priority | Test                                       | Justification                    | Mitigates Risk |
| -------------- | ------------ | -------- | ------------------------------------------ | -------------------------------- | -------------- |
| 1.6-VERIFY-010 | Verification | P0       | Vercel deployment logs show Next.js build  | Confirms frontend deployed       | OPS-001        |
| 1.6-VERIFY-011 | Verification | P0       | Vercel deployment logs show API routes     | Confirms backend deployed        | OPS-001        |
| 1.6-INT-010    | Integration  | P0       | Production frontend page loads             | End-user frontend accessibility  | OPS-001        |
| 1.6-INT-011    | Integration  | P0       | Production API health endpoint returns 200 | Backend operational verification | DATA-001       |

**Coverage**: ✅ AC6 fully covered (4 scenarios)

---

### AC7: Environment Variables Configured in Vercel

**Acceptance Criterion**: "Environment variables for production configured in hosting platform (not exposed in repository)"

#### Scenarios

| ID             | Level        | Priority | Test                                     | Justification                                 | Mitigates Risk |
| -------------- | ------------ | -------- | ---------------------------------------- | --------------------------------------------- | -------------- |
| 1.6-VERIFY-012 | Verification | P0       | All 7 env vars exist in Vercel dashboard | Configuration completeness check              | DATA-001       |
| 1.6-VERIFY-013 | Verification | P0       | `.env.local` in `.gitignore`             | Prevent secret exposure in git                | SEC-001        |
| 1.6-VERIFY-014 | Verification | P0       | No secrets in git history                | Security validation (`git log -S JWT_SECRET`) | SEC-001        |
| 1.6-INT-012    | Integration  | P0       | Production app loads env vars correctly  | Test via health endpoint + login              | DATA-001       |

**Coverage**: ✅ AC7 fully covered (4 scenarios)

---

### AC8: Deployment Status Visible in Repository

**Acceptance Criterion**: "Deployment status visible in repository (GitHub commit status, badges, or similar)"

#### Scenarios

| ID             | Level        | Priority | Test                                  | Justification                   | Mitigates Risk |
| -------------- | ------------ | -------- | ------------------------------------- | ------------------------------- | -------------- |
| 1.6-VERIFY-015 | Verification | P1       | GitHub commit shows deployment status | Developer feedback visibility   | OPS-002        |
| 1.6-VERIFY-016 | Verification | P1       | README has CI workflow badge          | Public project health indicator | N/A            |
| 1.6-VERIFY-017 | Verification | P2       | README has Vercel deployment badge    | Deployment status transparency  | OPS-002        |

**Coverage**: ✅ AC8 fully covered (3 scenarios)

---

### AC9: Failed Deployment Notifications

**Acceptance Criterion**: "Failed deployments send notification or alert (email, Slack, or platform notification)"

#### Scenarios

| ID             | Level        | Priority | Test                                               | Justification                      | Mitigates Risk |
| -------------- | ------------ | -------- | -------------------------------------------------- | ---------------------------------- | -------------- |
| 1.6-INT-013    | Integration  | P0       | Trigger deployment failure → Notification received | Critical alerting requirement      | OPS-002        |
| 1.6-VERIFY-018 | Verification | P1       | Vercel notifications configured                    | Verify email/Slack integration set | OPS-002        |

**Coverage**: ✅ AC9 fully covered (2 scenarios)

---

### AC10: Deployment Process Documented in README

**Acceptance Criterion**: "Deployment process documented in README with manual rollback procedure"

#### Scenarios

| ID             | Level        | Priority | Test                                    | Justification                   | Mitigates Risk |
| -------------- | ------------ | -------- | --------------------------------------- | ------------------------------- | -------------- |
| 1.6-VERIFY-019 | Verification | P1       | README documents CI/CD pipeline process | Developer onboarding essential  | OPS-003        |
| 1.6-VERIFY-020 | Verification | P1       | README documents rollback procedure     | Disaster recovery documentation | OPS-003        |
| 1.6-INT-014    | Integration  | P0       | Practice rollback → App still works     | Rollback procedure validation   | OPS-003        |

**Coverage**: ✅ AC10 fully covered (3 scenarios)

---

## Risk Coverage Mapping

All identified risks from risk profile are addressed by test scenarios:

| Risk ID  | Mitigated By Test Scenarios                                 | Coverage |
| -------- | ----------------------------------------------------------- | -------- |
| OPS-001  | 1.6-VERIFY-002, 1.6-INT-001 through 1.6-INT-011             | ✅ Full  |
| OPS-002  | 1.6-VERIFY-015, 1.6-VERIFY-017, 1.6-INT-013, 1.6-VERIFY-018 | ✅ Full  |
| OPS-003  | 1.6-VERIFY-019, 1.6-VERIFY-020, 1.6-INT-014                 | ✅ Full  |
| SEC-001  | 1.6-VERIFY-007, 1.6-VERIFY-013, 1.6-VERIFY-014              | ✅ Full  |
| SEC-002  | N/A (Risk mitigated by using Vercel Integration)            | ✅ N/A   |
| DATA-001 | 1.6-VERIFY-012, 1.6-INT-011, 1.6-INT-012                    | ✅ Full  |
| TECH-001 | 1.6-VERIFY-004, 1.6-VERIFY-006                              | ✅ Full  |
| TECH-002 | 1.6-VERIFY-001, 1.6-VERIFY-009                              | ✅ Full  |
| TECH-003 | Implicit in 1.6-INT-003 through 1.6-INT-006                 | ✅ Full  |
| PERF-001 | 1.6-VERIFY-005, 1.6-VERIFY-006                              | ✅ Full  |
| BUS-001  | 1.6-VERIFY-019 (documentation)                              | ✅ Full  |

**Risk Coverage**: 11/11 risks (100%)

---

## Recommended Execution Order

### Phase 1: Configuration Verification (P0 Verification Tests)

Execute first to catch configuration errors early:

1. **1.6-VERIFY-001**: `.github/workflows/ci.yml` exists
2. **1.6-VERIFY-003**: CI workflow YAML syntax valid
3. **1.6-VERIFY-004**: Workflow triggers config correct
4. **1.6-VERIFY-012**: All 7 env vars exist in Vercel dashboard
5. **1.6-VERIFY-013**: `.env.local` in `.gitignore`
6. **1.6-VERIFY-014**: No secrets in git history

**Expected Duration**: 10-15 minutes

---

### Phase 2: CI Pipeline Integration (P0 Integration Tests)

Execute to verify CI workflow end-to-end:

7. **1.6-INT-001**: Create test PR → Verify CI triggers
8. **1.6-INT-003**: CI runs ESLint job
9. **1.6-INT-004**: CI runs Prettier format check
10. **1.6-INT-005**: CI runs TypeScript type-check
11. **1.6-INT-006**: CI runs Vitest unit tests (68 tests)
12. **1.6-INT-007**: PR with lint error → CI fails → Merge blocked
13. **1.6-INT-008**: Fix lint error → CI passes → Merge allowed

**Expected Duration**: 20-30 minutes (includes CI run times)

---

### Phase 3: Deployment Integration (P0 Integration Tests)

Execute to verify CD workflow end-to-end:

14. **1.6-INT-009**: Merge PR to main → Deployment triggered
15. **1.6-VERIFY-010**: Vercel deployment logs show Next.js build
16. **1.6-VERIFY-011**: Vercel deployment logs show API routes
17. **1.6-INT-010**: Production frontend page loads
18. **1.6-INT-011**: Production API health endpoint returns 200
19. **1.6-INT-012**: Production app loads env vars correctly (health + login test)

**Expected Duration**: 15-20 minutes (includes deployment time)

---

### Phase 4: Monitoring & Recovery (P0/P1 Tests)

Execute to verify alerting and rollback:

20. **1.6-INT-013**: Trigger deployment failure → Notification received
21. **1.6-INT-014**: Practice rollback → App still works

**Expected Duration**: 10-15 minutes

---

### Phase 5: Documentation & Status (P1/P2 Tests)

Execute to verify completeness:

22. **1.6-VERIFY-002**: GitHub Actions enabled in repository
23. **1.6-VERIFY-007**: GitHub branch protection rule configured
24. **1.6-VERIFY-008**: Vercel GitHub Integration enabled
25. **1.6-VERIFY-015**: GitHub commit shows deployment status
26. **1.6-VERIFY-016**: README has CI workflow badge
27. **1.6-VERIFY-017**: README has Vercel deployment badge
28. **1.6-VERIFY-018**: Vercel notifications configured
29. **1.6-VERIFY-019**: README documents CI/CD pipeline process
30. **1.6-VERIFY-020**: README documents rollback procedure
31. **1.6-VERIFY-005**: All 4 jobs run in parallel (check CI logs)
32. **1.6-VERIFY-006**: pnpm caching configured
33. **1.6-VERIFY-009**: Alternative: `deploy.yml` exists (if GitHub Actions CD used)

**Expected Duration**: 15-20 minutes

---

### Total Execution Time

**Estimated Total**: 70-100 minutes (1.2 - 1.7 hours)

**Parallelization Opportunity**: Phases 1-2 can overlap if configuration is pre-verified

---

## Test Scenario Details

### Critical Path Tests (P0 - Must Pass)

#### 1.6-INT-007: PR with Lint Error → CI Fails → Merge Blocked

**Objective**: Verify CI pipeline correctly fails and blocks merge on code quality issues

**Preconditions**:

- `.github/workflows/ci.yml` configured
- GitHub branch protection enabled on main
- CI workflow active

**Test Steps**:

1. Create new branch: `test/intentional-lint-error`
2. Modify file to introduce ESLint error (e.g., add `var unused = 123;`)
3. Commit and push to branch
4. Create Pull Request to main
5. Observe GitHub Actions CI workflow execution

**Expected Results**:

- ✅ CI workflow triggers automatically
- ✅ ESLint job fails with error message
- ✅ CI workflow overall status: Failed (red X)
- ✅ GitHub UI shows "Merge blocked - CI checks must pass"
- ✅ Merge button disabled or shows warning

**Mitigates Risk**: OPS-001 (deployment of broken code)

**Priority**: P0 (Critical - core CI functionality)

---

#### 1.6-INT-009: Merge PR to Main → Deployment Triggered

**Objective**: Verify CD pipeline automatically deploys on main branch merge

**Preconditions**:

- CI workflow passing on PR
- Vercel GitHub Integration enabled (or `deploy.yml` configured)
- Production environment variables configured

**Test Steps**:

1. Merge passing PR to main branch
2. Observe Vercel dashboard (or GitHub Actions if using CD workflow)
3. Wait for deployment to complete

**Expected Results**:

- ✅ Deployment triggered within 30 seconds of merge
- ✅ Vercel build succeeds (or GitHub Actions deploy job succeeds)
- ✅ Deployment status updates on GitHub commit (green checkmark)
- ✅ Production URL updated with new deployment

**Mitigates Risk**: OPS-001 (deployment automation failure)

**Priority**: P0 (Critical - core CD functionality)

---

#### 1.6-INT-012: Production App Loads Env Vars Correctly

**Objective**: Verify all environment variables correctly configured in production

**Preconditions**:

- Application deployed to production
- All 7 env vars configured in Vercel

**Test Steps**:

1. Access production health endpoint: `GET https://your-app.vercel.app/api/health`
2. Verify response includes database connectivity status
3. Access production login page: `https://your-app.vercel.app/login`
4. Attempt login with correct credentials (teacher / password123)
5. Verify successful authentication

**Expected Results**:

- ✅ Health endpoint returns `200 OK` with `{"status": "ok"}`
- ✅ Health check confirms database connection (DATABASE_URL loaded)
- ✅ Login succeeds (JWT_SECRET loaded correctly)
- ✅ No environment variable errors in Vercel logs

**Mitigates Risk**: DATA-001 (DATABASE_URL misconfiguration), SEC-001 (JWT_SECRET exposure)

**Priority**: P0 (Critical - production functionality depends on env vars)

---

#### 1.6-INT-013: Trigger Deployment Failure → Notification Received

**Objective**: Verify deployment failure alerting works

**Preconditions**:

- Vercel notifications configured (email/Slack)
- Deployment workflow active

**Test Steps**:

1. Intentionally break deployment:
   - Option A: Introduce build error (invalid Next.js config)
   - Option B: Temporarily remove required env var from Vercel
2. Push to main branch to trigger deployment
3. Wait for deployment to fail
4. Check notification channels

**Expected Results**:

- ✅ Deployment fails as expected
- ✅ Notification received within 5 minutes (email/Slack/GitHub Actions notification)
- ✅ Notification contains failure reason
- ✅ GitHub commit status shows failed deployment (red X)

**Mitigates Risk**: OPS-002 (missing monitoring/alerting)

**Priority**: P0 (Critical - failure detection is essential)

---

#### 1.6-INT-014: Practice Rollback → App Still Works

**Objective**: Verify rollback procedure works and is well-documented

**Preconditions**:

- At least 2 successful deployments in production
- README documents rollback procedure

**Test Steps**:

1. Open Vercel dashboard
2. Navigate to Deployments tab
3. Find previous deployment (not current)
4. Click three-dot menu → "Promote to Production"
5. Confirm promotion
6. Wait for rollback to complete (instant)
7. Test production application

**Expected Results**:

- ✅ Previous deployment promoted successfully
- ✅ Production URL now serves previous version
- ✅ Application fully functional (health endpoint, login work)
- ✅ GitHub commit status updated to reflect rollback
- ✅ Rollback completed in <60 seconds

**Mitigates Risk**: OPS-003 (rollback procedure untested)

**Priority**: P0 (Critical - disaster recovery capability)

---

## Coverage Gap Analysis

**ACs Without Test Coverage**: None (10/10 ACs covered)

**Risks Without Test Coverage**: None (11/11 risks mitigated)

**Identified Gaps**: None

**Recommendation**: Test design is comprehensive. All acceptance criteria and risks have corresponding test scenarios.

---

## Test Environment Requirements

### GitHub Repository

- GitHub Actions enabled
- Branch protection rules on `main`:
  - Require status checks to pass before merging
  - Require CI workflow (`CI`) to pass
  - Prevent direct push to main (require PR)

### Vercel Project

- Project created and linked to GitHub repository
- GitHub Integration enabled
- Production environment variables configured:
  - `DATABASE_URL`
  - `JWT_SECRET`
  - `NEXT_PUBLIC_SUPABASE_URL`
  - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
  - `SUPABASE_SERVICE_KEY`
  - `NEXT_PUBLIC_APP_URL`
  - `NODE_ENV=production`
- Deployment notifications enabled (email/Slack)

### Test Data

- Hardcoded user credentials: `teacher` / `password123` (from Story 1.5)
- Database: Supabase PostgreSQL with schema from Stories 1.2-1.5
- Test PR branches: `test/intentional-lint-error`, `test/ci-verification`

---

## Test Execution Checklist

### Pre-Execution Setup

- [ ] Verify GitHub Actions enabled
- [ ] Verify Vercel project linked
- [ ] Verify all 7 env vars in Vercel
- [ ] Verify branch protection on main
- [ ] Create test branches

### During Execution

- [ ] Document all test results
- [ ] Screenshot CI workflow runs
- [ ] Screenshot Vercel deployment logs
- [ ] Record notification receipts
- [ ] Note any deviations from expected results

### Post-Execution Validation

- [ ] All P0 tests passed (18 scenarios)
- [ ] All P1 tests passed (8 scenarios)
- [ ] High risks mitigated (OPS-001, OPS-002, SEC-001, DATA-001)
- [ ] Documentation complete (README updated)
- [ ] Rollback procedure validated

---

## Summary for Quality Gate

```yaml
test_design:
  scenarios_total: 24
  by_level:
    verification: 18
    integration: 6
    unit: 0
  by_priority:
    p0: 12
    p1: 8
    p2: 4
  coverage_gaps: [] # All ACs covered
  risk_coverage: '11/11 (100%)'
  estimated_execution_time: '70-100 minutes'
```

---

**Test Design Complete**: `docs/qa/assessments/1.6-test-design-20251004.md`

**Key Insights**:

1. Infrastructure verification requires manual testing (no automated unit tests)
2. 24 test scenarios provide comprehensive coverage of all 10 ACs
3. All 11 identified risks have corresponding test coverage
4. Execution time reasonable for infrastructure setup validation (1-2 hours)
5. P0 tests focus on critical path: CI blocks bad code, CD deploys good code, rollback works

**Next Step**: Execute test scenarios during Story 1.6 implementation (Task 5 verification)
